import React, { useState, useRef, useLayoutEffect, useEffect } from "react";
import ReactPlayer from "react-player";
import Cookies from "js-cookie";
import { MdOutlineDoneOutline } from "react-icons/md"



var videoComplete = [];

const PentestingWithPython = () => {
    const [videoProgress, setVideoProgress] = useState([]);


    const courseData = [
        { id: 1, title: "Developing TCP Server & Understand Scokets", url: "https://www.youtube.com/embed/2P8s_KV51rM", },
        { id: 2, title: "Developing TCP Client", url: "https://www.youtube.com/embed/xbeNk-UQ0kE", },
        { id: 3, title: "Developing NMAP Scanner", url: "https://www.youtube.com/embed/1lh_SkY8cHk", },
        { id: 4, title: "Developing Port Scanne", url: "https://www.youtube.com/embed/d3D8PAZV51g", },
        { id: 5, title: "Developing Banner Grabbing Scripts", url: "https://youtube.com/embed/kUblkdrfM8M", },
        { id: 6, title: "TryHackMe - Python for Pentesters", url: "https://www.youtube.com/embed/JNYd44p7OCE", },
    ];

    const [currentVideoId, setCurrentVideoId] = useState(courseData[0].id);
    const [currentVideoUrl, setCurrentVideoUrl] = useState(courseData[0].url);
    const [currentVideoTitle, setCurrentVideoTitle] = useState(
        courseData[0].title
    );


    const [onClickCount, setOnClickCount] = useState(0);
    useEffect(() => {
        const abc = async () => {
            const myCookie = Cookies.get("myCookie");
            const data = {
                myCookie: myCookie,
                course_id: 1,
            };
            const response = await fetch(`http://127.0.0.1:5173/vids`, {
                method: "POST",
                headers: {
                    "content-type": "application/json",
                },
                body: JSON.stringify(data),
            });
            const jwt = await response.json();
            console.log(jwt.status[0].vid_num);

            videoComplete = jwt.status[0].vid_num;
            console.log(videoComplete);

            setVideoProgress(...videoProgress, videoComplete);

        };
        abc();

    }, [onClickCount]);
    console.log(videoProgress);
    const [progress, setProgress] = useState(calculateProgress());
    function calculateProgress() {
        const numVideos = courseData.length;
        const numSeenVideos = videoComplete.length;
        const progress = (numSeenVideos / numVideos) * 100;
        const slideincrease = (Math.floor(progress));

        console.log(numSeenVideos);
        console.log(numVideos);
        console.log(progress);

        return slideincrease;
    }
    console.log(currentVideoId);
    // Update progress state whenever videoProgress prop changes
    useEffect(() => {
        setProgress(calculateProgress());
    }, [videoProgress]);


    const [currentVideoIndex, setCurrentVideoIndex] = useState(0);

    const scrollRef = useRef(null);
    useLayoutEffect(() => {
        if (scrollRef.current) {
            window.scrollTo(0, 0);
        }
    }, []);

    const handleVideoClick = (id, title, url) => {
        setCurrentVideoId(id);
        setCurrentVideoTitle(title);
        setCurrentVideoUrl(url);
    };

    const handleNextLessonClick = async () => {
        const currentVideoIndex = courseData.findIndex(
            (video) => video.id === currentVideoId
        );
        if (currentVideoIndex < courseData.length - 1) {
            const nextVideo = courseData[currentVideoIndex + 1];
            setCurrentVideoId(nextVideo.id);
            setCurrentVideoUrl(nextVideo.url);
            setCurrentVideoTitle(nextVideo.title);
        }
        const vid_num = currentVideoId;
        const course_id = 1;
        const myCookie = Cookies.get("myCookie");
        const data = {
            myCookie: myCookie,
            course_id: course_id,
            vid_num: vid_num,
        };
        const response = await fetch(`http://127.0.0.1:5173/seenVideo`, {
            method: "POST",
            headers: {
                "content-type": "application/json",
            },
            body: JSON.stringify(data),
        });
        const jwt = await response.json();
        alert(jwt.status);

        // window.location.href = "/TestCourse";
        setOnClickCount(onClickCount + 1);

    };

    const handlePreviousLessonClick = () => {
        const currentVideoIndex = courseData.findIndex(
            (video) => video.id === currentVideoId
        );
        if (currentVideoIndex > 0) {
            const previousVideo = courseData[currentVideoIndex - 1];
            setCurrentVideoId(previousVideo.id);
            setCurrentVideoUrl(previousVideo.url);
            setCurrentVideoTitle(previousVideo.title);
        }
    };


    return (
        <>
            <div className="academy-courseVideo" ref={scrollRef}>
                <div className="academy-course-video">
                    {/* Video List */}

                    <div className="academy-course-video-progree-list">
                        <div className="academy-course-video-progress">
                            <div className="CourseVideo-progress">
                                Complete Course - {progress}%
                            </div>
                            <progress
                                value={progress / 100}
                                max="1"
                                className="academy-course-video-progress-bar"
                            />
                        </div>
                        <div>
                            <ul className="academy-course-video-list">
                                <h2 className="academy-course-video-list-h">Introduction</h2>
                                {courseData.slice(0, 6).map((video, index) => (
                                    <li
                                        key={video.id}
                                        onClick={() =>
                                            handleVideoClick(video.id, video.title, video.url)
                                        }
                                        className={videoComplete.includes(String(video.id)) ? 'watched' : ''}
                                       
                                    >
                                        {video.title}

                                        {videoComplete.includes(String(video.id)) &&
                                            <span style={{marginLeft: "1rem", color: "#04ff69", fontSize: "20px" }}><MdOutlineDoneOutline /></span>}
                                    </li>
                                ))}

                            </ul>
                        </div>
                    </div>

                    {/* Video Player */}
                    <div className="academy-course-video-videos">
                        <h2 className="academy-course-video-videos-h">
                            {currentVideoTitle}
                        </h2>
                        <iframe
                            src={currentVideoUrl}
                            className="academy-course-video-videos-video-player"

                        ></iframe>
                        <div style={{ display: "flex", width: "800px" }}>
                            {currentVideoId !== 1 && (
                                <button
                                    onClick={handlePreviousLessonClick}
                                    className="previous-button"
                                >
                                    Previous Lesson
                                </button>
                            )}
                            {currentVideoIndex < courseData.length - 1 ? (
                                <button onClick={handleNextLessonClick} className="next-button">
                                    Complete and Next Lesson
                                </button>
                            ) : (
                                <button className="complete-course-button">
                                    Complete Course
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            </div >
        </>
    );
};

export default PentestingWithPython;
